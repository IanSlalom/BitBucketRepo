<apex:page showHeader="true" sidebar="false">
    <apex:includeScript value="/soap/ajax/34.0/connection.js" />
    <apex:includeScript value="/soap/ajax/34.0/apex.js" />
    
    <!-- <apex:includeScript value="https://maps.googleapis.com/maps/api/js?client=gme-cloudbiltinc" /> -->

    <!--
    <apex:includeScript value="{!URLFOR($Resource.MA_Scheduler, '/overlappingmarkerspiderfier/oms.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.MA_Scheduler, '/async/async.min.js')}"/>
    -->

    <apex:includeScript value="{!URLFOR($Resource.MA_Scheduler, '/fullcalendar-scheduler-1.2.0/lib/jquery.min.js')}" />


    <script>
        $ = jQuery.noConflict();
        //var map;
        //var selectedStore = '';
        var isIndividual = true;
        var storeFound = false;
        var storeRetrievalProcessed = false;
        var storeIdToResourceIndividualityMap = {};
        var apexMainPageController = 'MA_SchedulerController';
        var processStoreResponse = { onSuccess: processStoreSuccess, onFailure: processResponseError };
        var processTimezoneOptionsResponse = { onSuccess: processTimezoneOptionsSuccess, onFailure: processResponseError };

        $(function() {
            sforce.connection.sessionId = '{!$Api.Session_Id}';
            $('#storeSelectDiv, .hideIndividual').hide();

            retrieveStoreIds();
            retrieveTimezoneOptions();

            //$('#calendar').fullCalendar('refetchResources');

            //if (isIndividual) {
                //$('#settings, #filters, #listView, #optimize, #map, #calendarFilter').hide();
            //}

            /*
            var mapOptions = {
                        center: new google.maps.LatLng(35.2033533,-80.979609),
                        zoom: 10,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                      };
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            */
        });

        function retrieveTimezoneOptions() {
            sforce.apex.execute(apexMainPageController, 'retrieveTimezoneOptions', {}, processTimezoneOptionsResponse);
        }

        function processTimezoneOptionsSuccess(response) {
            response = JSON.parse(response);
            console.log(response);

            if (response.success) {
                var timezoneOptionsHtml = '';
                for (var key in response.timezoneOptions) {
                    timezoneOptionsHtml += '<option value="' + key + '">' + response.timezoneOptions[key] + '</option>';
                }

                $('#timezoneOptions').append(timezoneOptionsHtml);
            }
        }

        function retrieveStoreIds() {
            sforce.apex.execute(apexMainPageController, 'retrieveRecords', { objType: 'Scheduler' }, processStoreResponse);
        }

        function processStoreSuccess(response) {
            response = JSON.parse(response);
            console.log(response);
            if (response.success) {
                var storeSelectOptions = '';
                for (var i = 0, len = response.objList.length; i < len; i++) {
                    var record = response.objList[i];
                    storeIdToResourceIndividualityMap[record.Retail_Location__c] = record.Resource_Type__c != 'Scheduler';
                    //storeIds.push(record.Retail_Location__c);
                    storeSelectOptions += '<option value="' + record.Retail_Location__c + '">' + record.Retail_Location__r.Name + '</option>';
                    
                    /*
                    if (record.Resource_Type__c != 'Scheduler') {
                        isIndividual = true;
                    }
                    */
                }

                $('#storeSelect').append(storeSelectOptions);

                if ($('#storeSelect option').length > 1) {
                    $('#storeSelectDiv').show();
                }

                var selectedStoreId = $('#storeSelect').val();
                if (selectedStoreId != '' && selectedStoreId != undefined && selectedStoreId != null) {
                    storeFound = true;
                    isIndividual = storeIdToResourceIndividualityMap[selectedStoreId];

                    if (!isIndividual) {
                        $('.hideIndividual').show();
                    }
                }

                storeRetrievalProcessed = true;
                newCalendarFilter = true;
                $('#calendar').fullCalendar('refetchResources');
            }
            else {
                handleError('MA_Scheduler : retrieveStoreIds' + apexMainPageController, response);
            }
        }

        function initializeListViewAttributes() {
            //$('#allBox').attr('disabled', true);
            //$('.listButtons li:not(".lastItem"), .x-grid3-td-checkbox').hide();
            $('.listButtons li:not(".lastItem"), .x-grid3-td-checkbox').hide();
            $('.listViewportWrapper').ajaxComplete(onListViewLoad());
        }

        function onListViewLoad() {
            setTimeout(function() {
                //$('.x-grid3-td-checkbox').hide();
                var records = $('.listViewportWrapper .x-grid3-row .x-grid3-col');
                for (var i = 0, len = records.length; i < len; i++) {
                    var record = records[i];

                    /*
                    record.onclick = function(e) {
                        //showAvailabilityModal(this);


                        var workOrderElRow = $(this).closest('.x-grid3-row')[0];
                        var workOrderId = $(workOrderElRow).find('.x-grid3-col-LIST_RECORD_ID').text();
                        $('#listViewOptionsRecordId').val(workOrderId);
                        //$('#listViewOptionsModal').offset({ top: e.pageY, left: e.pageX }).show();
                        //$('#listViewOptionsModal').offset({ top: e.clientY, left: e.clientX }).show();
                        //$('#listViewOptionsModal').offset({ top: e.y, left: e.x }).show();
                        //$('#listViewOptionsModal').offset({ top: e.screenY, left: e.pageX }).show();
                        $('#listViewOptionsModal').offset({ top: e.pageY, left: e.pageX }).show();
                        //$('#listViewOptionsModal').offset({ top: e.offsetY, left: e.offsetX }).show();
                    };
                    */


                    record.onclick = function(e) {
                        console.log(e);
                        var workOrderElRow = $(this).closest('.x-grid3-row')[0];
                        var workOrderId = $(workOrderElRow).find('.x-grid3-col-LIST_RECORD_ID').text();
                        $('#listViewOptionsRecordId').val(workOrderId);
                        //$('#listViewOptionsModal').offset({ top: e.pageY, left: e.pageX }).show();
                        //$('#listViewOptionsModal').css({ position: 'absolute', top: (e.pageY - e.layerX), left: (e.pageX - e.layerY) }).show();
                        $('#listViewOptionsModal').css({ position: 'absolute', top: (e.pageY - 110), left: e.pageX }).show();
                        //$('#listViewOptionsModal').css({ position: 'absolute', top: (e.pageY), left: e.pageX }).show();
                    };

                    /*
                    record.oncontextmenu = function(e) {
                        console.log(e);
                        e.preventDefault();
                        var workOrderElRow = $(this).closest('.x-grid3-row')[0];
                        var workOrderId = $(workOrderElRow).find('.x-grid3-col-LIST_RECORD_ID').text();
                        $('#listViewOptionsRecordId').val(workOrderId);
                        //$('#listViewOptionsModal').offset({ top: e.pageY, left: e.pageX }).show();
                        //$('#listViewOptionsModal').css({ position: 'absolute', top: (e.pageY - e.layerX), left: (e.pageX - e.layerY) }).show();


                        var posX;
                        var posY;

                        //console.log(document.body.scrollLeft);
                        //console.log(document.documentElement.scrollLeft);

                        if (e.pageX || e.pageY) {
                            posX = e.pageX;
                            posY = e.pageY - (e.screenY - e.clientY);
                        }
                        else if (e.clientX || e.clientY) {
                            posX = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                            posY = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
                        }


                        console.log(posX);
                        console.log(posY);




                        $('#listViewOptionsModal').css({ position: 'absolute', top: posY, left: posX }).show();
                        //$('#listViewOptionsModal').css({ position: 'absolute', top: (e.pageY), left: e.pageX }).show();
                    };
                    */


                    /*
                    if ($(record).find('a, input[type="checkbox"]').length == 0) {
                        record.onclick = function() { showAvailabilityModal(this); };
                    }
                    */

                    var links = $(record).find('a, input[type="checkbox"]');
                    for (var x = 0, linkLen = links.length; x < linkLen; x++) {
                        var link = links[x];
                        link.onclick = function(event) {
                            event.cancelBubble = true;
                            if (event.stopPropagation) {
                                event.stopPropagation();
                            }
                        };
                    }
                }
            }, 500);
        }

        function closeListViewOptionsModal() {
            $('#listViewOptionsModal').hide();
        }

        function formatAddress(address) {
            address = address.replace(new RegExp('undefined', 'g'), '').replace(', ,', ',').replace(',  ', ', ');
            if (address.startsWith(', ')) {
                address = address.substring(2);
            }
            if (address.endsWith(', ')) {
                address = address.substring(0, address.lastIndexOf(', '));
            }

            return address;
        }

        function processResponseError(error) {
            console.log(error);
            if (!error.faultstring) {
                error = { error: 'Response Error'};
            }
            handleError('ERROR', error);
        }

        function handleError(componentName, error) {
            $('#errorMessage').text(componentName + ' : ' + (error.error ? error.error : error.faultstring));
            $('#errorModal').show();
            $('#errorModal').addClass('ma-open');
            $('#errorModalOverlay').addClass('ma-in');
            $('#loaderModal').hide();
        }
        
        $(document).mouseup(function (e)
        {
            var container = $("#listViewOptionsModal, #eventOptionsModal");
        
            if (!container.is(e.target) // if the target of the click isn't the container...
                && container.has(e.target).length === 0) // ... nor a descendant of the container
            {
                container.hide();
            }
        });
        
        $( document ).ready(function() {
            $('#errorModal').addClass('ma-in');
        });

        function viewEditWorkOrder(isCalendar) {
            var workOrderId;
            if (isCalendar) {
                workOrderId = $('#eventOptionsRecordId').val();
            }
            else {
                workOrderId = $('#listViewOptionsRecordId').val();
            }

            var win = window.open('/' + workOrderId, '_blank', 'height=500, width=800, location=no, menubar=no, scrollbars=yes, status=no, titlebar=no, toolbar=no, resizable=yes, fullscreen=no');
            var winTimer = setInterval(function() {
                if (win.closed) {
                    clearInterval(winTimer);
                    if (!isBatchResources) {
                        $('#loaderModal').show();
                        $('.listViewportWrapper .refreshListButton').click();
                        $('#calendar').fullCalendar('refetchEvents');
                        $('#loaderModal').hide();
                    }
                }
            }, 500);
        }
        
    </script>

    <c:MA_SchedulerErrorComp />
    <c:MA_SchedulerLoaderComp />
    <c:MA_SchedulerStylingComp />
    <apex:stylesheet value="{!URLFOR($Resource.MA_Scheduler, '/css/ma2-style.css')}" />
    <c:MA_SchedulerSettingsComp />
    <c:MA_SchedulerAssignResourceComp />
    <c:MA_SchedulerCancelAppointmentComp />
    <c:MA_SchedulerWorkOrderSchedulingComp />
    <c:MA_SchedulerRoutes />
    <c:MA_SchedulerMainNav />
    <c:MA_SchedulerResourceRouteComp />

    <!--
    <div id="settings" class="hideIndividual">
        <span id="gearIcon" onclick="openSettingsModal();"><img src="{!URLFOR($Resource.MA_Scheduler, '/images/settings_60.png')}" /></span> Settings
    </div>
    -->
    
    <!--
    <div id="optimize" class="hideIndividual">
        <button class="ma-button ma-button--yellow" onclick="MAschedRoutes.showOptyModal();">Batch Assign</button>
        <button class="ma-button ma-button--yellow" onclick="MAschedRoutes.showMap();">MAP</button>
    </div>
    -->

    <!--
    <div id="filters" class="hideIndividual">
        ***INSERT RESOURCE FILTERING HERE***
     -->

    <c:MA_SchedulerCalendarComp />

    <div id="listView" class="hideIndividual pad-0-10 batchHide">
        <apex:enhancedList id="unscheduledListView" type="RbA_Work_Order__c" height="300" rowsPerPage="25" customizable="true" oncomplete="initializeListViewAttributes()" />
    </div>
    
    <div id="unassignedBatch" class="unassigned-batch pad-15-10 batchShow" >
        <div>
            <h2><span>Unassigned Batched Work Orders</span></h2>
        </div>
        
        <table id ="unassignedBatch-table" class ="unassigned-batch-wo" title="Unassigned WorkOrders">
            <thead id="unassignedBatch-header" class="unassigned-batch-header">
                <tr>
                    <th id="unassignedBatch-action">Action</th>
                    <th id="unassignedBatch-wo">WorkOrder#</th>
                    <th id="unassignedBatch-contact">Contact</th>
                    <th id="unassignedBatch-account">Account</th>
                    <th id="unassignedBatch-appt">Appointment Duration</th>
                    <th id="unassignedBatch-cdate">Created Date</th>
                </tr>
            </thead>
            <tbody id="unassignedBatch-body">
                <tr>
                    <td colspan="2"><p>There are no work orders to be displayed.</p></td>
                </tr>
            </tbody>
            
        </table>
    </div>

    <div id="listViewOptionsModal">
        <!-- <span class="ma-modal-close" onclick="closeListViewOptionsModal();"><img src="{!URLFOR($Resource.MA_Scheduler, '/images/close_60.png')}" /></span> -->
        <input type="hidden" id="listViewOptionsRecordId" />
        <div id="" onclick="showAvailabilityModal(false, false); closeListViewOptionsModal();">Schedule Work Order</div>
        <div onclick="showAssignResourceModal(false, false, false); closeListViewOptionsModal();">Assign a Resource</div>
        <div onclick="viewEditWorkOrder(false); closeListViewOptionsModal();">View / Edit</div>
    </div>

</apex:page>